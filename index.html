<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>LOGDAY</title>
<style>
  body{
    font-family:-apple-system,BlinkMacSystemFont,sans-serif;
    padding:20px;
    line-height:1.6;
    background:#fafafa;
    padding-bottom: 170px; /* InputBar ã®ã¶ã‚“ */
  }

  h2{margin-bottom:20px;}

  #nav{
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom:8px;
  }
  #navRight{ margin-left:auto; display:flex; align-items:center; gap:8px; }

  #prev,#today,#next{
    padding:6px 10px;
    border-radius:10px;
    border:1px solid rgba(0,0,0,0.16);
    background:rgba(255,255,255,0.9);
    cursor:pointer;
    line-height:1;
    -webkit-tap-highlight-color: transparent;
  }
  #prev:active,#today:active,#next:active{ transform: translateY(1px); }

  .entry{
    background:#fff;
    padding:10px 12px;
    border-radius:10px;
    box-shadow:0 1px 4px rgba(0,0,0,0.06);
    margin-bottom:12px;
  }
  .time{color:#888;width:60px;display:inline-block;vertical-align:top;}
  .text{display:block;margin-left:60px;}

  img.entryPhoto{
    display:block;
    margin-top:6px;
    margin-left:60px;
    max-width:100%;
    border-radius:10px;
  }
  .fileLine{
    margin-left:60px;
    margin-top:6px;
    color:#666;
    font-size:14px;
  }

  #meta{margin-bottom:12px;color:#666;}
  #weather{font-weight:bold;}
  #dayNote{font-size:.9em;margin-top:4px;}

  /* â–¼ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆæœˆï¼‰ */
  #calendar{
    display:grid;
    grid-template-columns:repeat(7,1fr);
    gap:4px;
    margin-bottom:16px;
  }
  #calendar button{
    padding:6px 0;
    border-radius:8px;
    border:1px solid rgba(0,0,0,0.16);
    background:#fff;
    cursor:pointer;
    font-size:.85em;
    -webkit-tap-highlight-color: transparent;
  }
  #calendar button.active{ background:#111; color:#fff; border-color:#111; }
  #calendar.hidden{display:none;}

  /* â–¼é€±ãƒãƒ¼ */
  #weekBar{
    display:grid;
    grid-template-columns:repeat(7,1fr);
    gap:6px;
    margin:10px 0 16px;
  }
  #weekBar button{
    padding:8px 0;
    border-radius:12px;
    border:1px solid rgba(0,0,0,0.14);
    background:#fff;
    cursor:pointer;
    font-size:.85em;
    line-height:1.1;
    -webkit-tap-highlight-color: transparent;
  }
  #weekBar button .d{
    display:block;
    font-size:.75em;
    color:#666;
    margin-top:2px;
  }
  #weekBar button.active{background:#111;color:#fff;border-color:#111;}
  #weekBar button.active .d{color:#fff;opacity:.85;}

  /* â–¼è¡¨ç¤ºåˆ‡æ›¿ï¼ˆé€±/æœˆ/è¨­å®šï¼‰ */
  #viewToggle{ display:flex; gap:8px; align-items:center; }
  #viewToggle button{
    padding:6px 12px;
    border-radius:999px;
    border:1px solid rgba(0,0,0,0.18);
    background:rgba(255,255,255,0.85);
    cursor:pointer;
    font-size:.9em;
    line-height:1;
    -webkit-tap-highlight-color: transparent;
    transition: transform .08s ease, background .15s ease, border-color .15s ease;
    backdrop-filter: blur(6px);
    letter-spacing: .2px;
  }
  #viewToggle button:active{ transform: translateY(1px); }
  #viewToggle button.active{ background:#111; color:#fff; border-color:#111; }
  #viewToggle button.iconOnly{
    width:36px; height:32px; padding:0;
    display:inline-flex; align-items:center; justify-content:center;
    border-radius:10px; font-size:15px;
  }

  /* â–¼ç©ºçŠ¶æ…‹ */
  #entries{ min-height: 42vh; }
  .emptyState{
    min-height: 40vh;
    display:flex;
    align-items:center;
    justify-content:center;
    color:#888;
    text-align:center;
    font-size:.95em;
  }

  /* â–¼ä¸‹ã‹ã‚‰å‡ºã‚‹å…¥åŠ›ãƒãƒ¼ */
  #inputBar{
    position:fixed;
    left:0; right:0; bottom:0;
    background:#fff;
    border-top:1px solid #ddd;
    padding:10px 12px;

    display:flex;
    flex-wrap:wrap;            /* â˜…ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯æ¬¡è¡Œã«è½ã¨ã™ */
    align-items:center;
    gap:8px;

    z-index:9999;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.06);
    max-height:320px;
  }

  #inputBar.expanded{
    margin: 0 12px 12px;
    border-radius:16px;
    border-top:none;
    border:1px solid rgba(0,0,0,0.10);
    padding:12px;
    box-shadow: 0 -10px 26px rgba(0,0,0,0.18);
    transform: translateY(-2px);
    background: rgba(255,255,255,0.98);
    backdrop-filter: blur(10px);
  }

  .iconBtn{
    width:34px; height:34px;
    border-radius:12px;
    border:1px solid rgba(0,0,0,0.14);
    background:#fff;
    cursor:pointer;
    font-size:16px;
    line-height:1;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    -webkit-tap-highlight-color: transparent;
    flex:0 0 auto;
  }
  .iconBtn:active{transform:translateY(1px);}

  /* æ™‚è¨ˆæ¨ªã®æ™‚é–“è¡¨ç¤ºï¼ˆæœªæŒ‡å®šã¯è–„ã„ï¼‰ */
  #timeHint{
    height:34px;
    display:inline-flex;
    align-items:center;
    padding:0 10px;
    border-radius:12px;
    border:1px solid rgba(0,0,0,0.10);
    background:rgba(0,0,0,0.02);
    font-size:14px;
    color:#111;
    flex:0 0 auto;
    user-select:none;
  }
  #timeHint.isAuto{ opacity:0.35; } /* æœªæŒ‡å®šï¼ˆè‡ªå‹•ï¼‰ */
  #timeHint.isSet{ opacity:0.80; }  /* æŒ‡å®šæ¸ˆ */

  #logInput{
    flex:1;
    min-width:0;               /* â˜…iOSã®ã¯ã¿å‡ºã—å¯¾ç­– */
    height:36px;
    resize:none;
    border-radius:12px;
    border:1px solid rgba(0,0,0,0.18);
    padding:8px 10px;
    font-family:-apple-system,BlinkMacSystemFont,sans-serif;
    box-sizing:border-box;
    outline:none;
    background:#fff;
    font-size:16px;
    line-height:1.4;
    transition: height .25s ease, max-height .25s ease, padding .25s ease;
  }

  #inputBar.expanded #logInput{
    height: 120px;
    max-height: 180px;
    padding: 10px 12px;
    line-height: 1.5;
  }

  #saveBtn{
    padding:0 14px;
    height:34px;
    border-radius:12px;
    border:none;
    background:#111;
    color:#fff;
    cursor:pointer;
    white-space: nowrap;
    display:none; /* é€šå¸¸ã¯å‡ºã•ãªã„ */
    flex:0 0 auto;
  }
  #inputBar.expanded #saveBtn{ display:inline-flex; align-items:center; justify-content:center; }

  /* previewã¯å¿…ãšæ¬¡è¡Œ100% */
  #previewArea{
    flex:0 0 100%;
    width:100%;
  }
  #previewArea img{
    max-width:100%;
    border-radius:10px;
    margin-top:8px;
  }
  #previewArea .filePreview{
    margin-top:8px;
    color:#666;
    font-size:14px;
  }

  /* hidden inputs */
  .fileInput{
    position:fixed;
    top:-10000px; left:-10000px;
    width:1px; height:1px;
    opacity:0;
  }

  /* iOSã§æ™‚é–“pickerã‚’ç¢ºå®Ÿã«ï¼šé€æ˜inputã‚’æ™‚è¨ˆã®ä¸Šã«é‡ã­ã‚‹ */
  #logTime{
    position:absolute;
    left:12px; bottom:10px;
    width:34px; height:34px;
    opacity:0;
    z-index:10001;
  }
  #inputBar.expanded #logTime{
    left:12px;
    bottom:auto;
    top:12px;
  }

  /* â–¼è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */
  #settingsModal{
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 20000;
  }
  #settingsModal.open{ display:flex; }

  #settingsBackdrop{
    position:absolute;
    inset:0;
    background: rgba(0,0,0,0.35);
  }

  #settingsPanel{
    position: relative;
    width: min(520px, calc(100% - 32px));
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.22);
    padding: 16px;
  }

  #settingsPanel h3{ margin: 0 0 12px; font-size: 16px; }
  #settingsPanel .row{ display:flex; gap:10px; flex-wrap: wrap; }

  .ghostBtn{
    padding:10px 12px;
    border-radius:12px;
    border:1px solid rgba(0,0,0,0.18);
    background:#fff;
    cursor:pointer;
    font-size:.95em;
    display:inline-flex;
    align-items:center;
    justify-content:center;
  }

  /* toast */
  #toast{
    position:fixed;
    left:50%;
    bottom:140px;
    transform:translateX(-50%);
    background:#111;
    color:#fff;
    padding:10px 18px;
    border-radius:999px;
    font-size:14px;
    opacity:0;
    pointer-events:none;
    transition:opacity .25s ease, transform .25s ease;
    z-index:30000;
  }
  #toast.show{
    opacity:1;
    transform:translateX(-50%) translateY(-4px);
  }
</style>
</head>
<body>

<div id="nav">
  <button id="prev">â†</button>
  <button id="today">ä»Šæ—¥</button>
  <button id="next">â†’</button>

  <div id="navRight">
    <div id="viewToggle">
      <button id="weekBtn" class="active">é€±</button>
      <button id="monthBtn">æœˆ</button>
      <button id="settingsBtn" class="iconOnly" type="button" aria-label="è¨­å®š" title="è¨­å®š">âš™ï¸</button>
    </div>
  </div>
</div>

<div id="calendar" class="hidden"></div>
<div id="weekBar"></div>

<h2 id="dateHeader">
  <span id="currentDate"></span>
  <span id="currentWeekday"></span>
</h2>

<div id="meta">
  <span id="weather"></span>
  <div id="dayNote"></div>
</div>

<div id="entries"></div>

<!-- â–¼ä¸‹ã‹ã‚‰å‡ºã‚‹å…¥åŠ›ãƒãƒ¼ -->
<div id="inputBar">
  <!-- ä»•æ§˜ï¼šå·¦ã‹ã‚‰ï¼ˆï¼‹ï¼‰ï¼ˆæ™‚è¨ˆï¼‰ï¼ˆæ™‚é–“è¡¨ç¤ºï¼‰ï¼ˆå…¥åŠ›æ¬„ï¼‰ -->
  <button class="iconBtn" id="plusBtn" type="button" title="è¿½åŠ ">ï¼‹</button>

  <!-- labelã§é–‹ã‘ã‚‹ + JSã§ã‚‚clickä¿é™º -->
  <label class="iconBtn" id="timeBtn" for="logTime" title="æ™‚é–“" role="button">ğŸ•’</label>

  <div id="timeHint" class="isAuto">--:--</div>

  <textarea id="logInput" placeholder="ä»Šæ—¥ã®ã²ã¨ã“ã¨â€¦"></textarea>
  <button id="saveBtn" type="button">ä¿å­˜</button>

  <div id="previewArea"></div>

  <!-- hidden inputs -->
  <input id="logTime" type="time" class="fileInput">
  <input id="fileInput" type="file" class="fileInput" accept="*/*">
</div>

<!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="settingsModal" aria-hidden="true">
  <div id="settingsBackdrop"></div>
  <div id="settingsPanel" role="dialog" aria-modal="true" aria-label="è¨­å®š">
    <h3>è¨­å®š</h3>
    <div class="row">
      <button id="exportLogday" class="ghostBtn" type="button">ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãå‡ºã™</button>

      <label class="ghostBtn" role="button">
        ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã™ã‚‹
        <input id="importFile" class="fileInput" type="file" accept="application/json" />
      </label>

      <button id="closeSettings" class="ghostBtn" type="button">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<div id="toast">ä¿å­˜ã—ã¾ã—ãŸ</div>

<script>
/* =======================
   State / Utils
======================= */
let viewMode = 'week';
let currentDate = new Date().toISOString().slice(0,10);

const $ = (id) => document.getElementById(id);
const pad2 = (n) => String(n).padStart(2,'0');
const nowHHMM = () => {
  const d = new Date();
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
};

function formatYMD(d){ return d.toISOString().slice(0,10); }

function renderDateHeader(dateStr){
  const d = new Date(dateStr);
  const dateText = d.toLocaleDateString('ja-JP',{year:'numeric',month:'2-digit',day:'2-digit'});
  const weekdayText = d.toLocaleDateString('ja-JP',{weekday:'short'});
  $('currentDate').textContent = dateText;
  $('currentWeekday').textContent = `ï¼ˆ${weekdayText}ï¼‰`;
}

function startOfWeek(dateStr){
  const d = new Date(dateStr);
  const day = d.getDay();
  const diff = (day === 0) ? -6 : (1 - day);
  d.setDate(d.getDate() + diff);
  return d;
}

function shiftByView(dateStr, diff){
  const d = new Date(dateStr);
  if (viewMode === 'month'){
    d.setDate(1);
    d.setMonth(d.getMonth() + diff);
  } else {
    d.setDate(d.getDate() + diff);
  }
  return formatYMD(d);
}

function getDayData(dateKey){
  const dayData = JSON.parse(localStorage.getItem(dateKey) || '{}');
  dayData.entries = dayData.entries || [];
  return dayData;
}
function saveDayData(dateKey, dayData){
  localStorage.setItem(dateKey, JSON.stringify(dayData));
}
function sortEntries(dayData){
  dayData.entries.sort((a,b) => (a.time || '').localeCompare(b.time || ''));
}

function showToast(message){
  const toast = $('toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 1200);
}

/* =======================
   Week bar / Calendar
======================= */
function renderWeekBar(dateStr){
  const bar = $('weekBar');
  bar.style.display = (viewMode === 'week') ? 'grid' : 'none';
  if (viewMode !== 'week') return;

  bar.innerHTML = '';
  const start = startOfWeek(dateStr);
  const wnames = ['æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ','æ—¥'];

  for(let i=0;i<7;i++){
    const d = new Date(start);
    d.setDate(start.getDate() + i);
    const ymd = formatYMD(d);

    const btn = document.createElement('button');
    btn.dataset.date = ymd;
    btn.innerHTML = `${wnames[i]}<span class="d">${d.getDate()}</span>`;
    btn.classList.toggle('active', ymd === currentDate);

    btn.onclick = () => {
      currentDate = ymd;
      loadDay(currentDate);
      renderWeekBar(currentDate);
    };
    bar.appendChild(btn);
  }
}

function generateCalendar(){
  const cal = $('calendar');
  cal.innerHTML = '';

  const d = new Date(currentDate);
  const year = d.getFullYear();
  const month = d.getMonth();

  const firstDay = new Date(year, month, 1);
  const lastDate = new Date(year, month + 1, 0).getDate();
  const blanks = (firstDay.getDay() + 6) % 7;

  for(let i=0;i<blanks;i++){
    const empty = document.createElement('button');
    empty.disabled = true;
    empty.style.visibility = 'hidden';
    cal.appendChild(empty);
  }

  for(let day=1; day<=lastDate; day++){
    const dayStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const btn = document.createElement('button');
    btn.textContent = day;
    btn.dataset.date = dayStr;
    btn.classList.toggle('active', dayStr === currentDate);

    btn.onclick = () => {
      currentDate = dayStr;
      renderDateHeader(currentDate);
      generateCalendar();
      loadDay(currentDate);
    };
    cal.appendChild(btn);
  }
}

/* =======================
   Render Day
======================= */
function loadDay(dateStr){
  renderDateHeader(dateStr);

  const entriesDiv = $('entries');
  entriesDiv.innerHTML = '';

  const saved = getDayData(dateStr);

  if(saved.entries && saved.entries.length){
    saved.entries.forEach(entry=>{
      const div = document.createElement('div');
      div.className = 'entry';

      const time = document.createElement('span');
      time.className = 'time';
      time.textContent = entry.time || 'â€¢';

      const text = document.createElement('span');
      text.className = 'text';
      text.textContent = entry.text || '';

      div.appendChild(time);
      div.appendChild(text);

      if (entry.photo) {
        const img = document.createElement('img');
        img.className = 'entryPhoto';
        img.src = entry.photo;
        img.alt = 'photo';
        div.appendChild(img);
      }

      if (entry.fileName) {
        const fileLine = document.createElement('div');
        fileLine.className = 'fileLine';
        fileLine.textContent = `ğŸ“ ${entry.fileName}`;
        div.appendChild(fileLine);
      }

      entriesDiv.appendChild(div);
    });
  } else {
    entriesDiv.innerHTML = '<div class="emptyState">ã“ã®æ—¥ã¯ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
  }
}

/* =======================
   View Switch / Nav
======================= */
const weekBtn = $('weekBtn');
const monthBtn = $('monthBtn');
const calEl = $('calendar');

function showWeek(){
  viewMode = 'week';
  weekBtn.classList.add('active');
  monthBtn.classList.remove('active');
  calEl.classList.add('hidden');
  renderWeekBar(currentDate);
  loadDay(currentDate);
}
function showMonth(){
  viewMode = 'month';
  monthBtn.classList.add('active');
  weekBtn.classList.remove('active');
  calEl.classList.remove('hidden');
  generateCalendar();
  loadDay(currentDate);
}

['click','touchend'].forEach(evt => {
  weekBtn.addEventListener(evt, e => { e.preventDefault(); showWeek(); }, {passive:false});
  monthBtn.addEventListener(evt, e => { e.preventDefault(); showMonth(); }, {passive:false});
});

$('prev').onclick = () => {
  currentDate = shiftByView(currentDate, -1);
  if (viewMode === 'month') generateCalendar();
  loadDay(currentDate);
  renderWeekBar(currentDate);
};
$('next').onclick = () => {
  currentDate = shiftByView(currentDate, 1);
  if (viewMode === 'month') generateCalendar();
  loadDay(currentDate);
  renderWeekBar(currentDate);
};
$('today').onclick = () => {
  currentDate = new Date().toISOString().slice(0,10);
  if (viewMode === 'month') generateCalendar();
  loadDay(currentDate);
  renderWeekBar(currentDate);
};

/* =======================
   Input Bar
======================= */
const inputBar = $('inputBar');
const plusBtn = $('plusBtn');
const timeBtn = $('timeBtn');
const timeHint = $('timeHint');
const logInput = $('logInput');
const saveBtn  = $('saveBtn');

const logTimeEl   = $('logTime');
const fileInputEl = $('fileInput');
const previewArea = $('previewArea');

let timePinned = false;     // true: ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã‚ã‚Š
let timeTicker = null;

function expandInputBar(){ inputBar.classList.add('expanded'); }
function collapseInputBar(){ inputBar.classList.remove('expanded'); }

function refreshTimeHint(){
  const has = !!(logTimeEl.value && logTimeEl.value.trim());
  timePinned = has;

  if (has) {
    timeHint.textContent = logTimeEl.value;
    timeHint.classList.remove('isAuto');
    timeHint.classList.add('isSet');
  } else {
    timeHint.textContent = nowHHMM();     // â˜…æœªæŒ‡å®šã¯ç¾åœ¨æ™‚åˆ»ã‚’è¡¨ç¤º
    timeHint.classList.add('isAuto');
    timeHint.classList.remove('isSet');
  }
}

function startTimeTicker(){
  if (timeTicker) return;
  timeTicker = setInterval(() => {
    if (!timePinned) refreshTimeHint();
  }, 1000);
}

function getTimeForSave(){
  // æŒ‡å®šã‚ã‚Šâ†’ãã‚Œã€æœªæŒ‡å®šâ†’ä¿å­˜æ™‚ã®ç¾åœ¨æ™‚åˆ»
  return (logTimeEl.value && logTimeEl.value.trim()) ? logTimeEl.value : nowHHMM();
}

/* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã§å±•é–‹ */
logInput.addEventListener('focus', expandInputBar);

/* å¤–ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹ï¼ˆ1å›ã ã‘ï¼‰ */
document.addEventListener('pointerdown', (e) => {
  if (document.activeElement !== logInput) return;
  if (inputBar.contains(e.target)) return;
  logInput.blur();
  collapseInputBar();
});

/* ï¼‹ï¼šiOSçµ±åˆã‚·ãƒ¼ãƒˆ */
plusBtn.onclick = () => fileInputEl.click();

/* æ™‚è¨ˆï¼šlabelãŒåŠ¹ã‹ãªã„ç«¯æœ«å¯¾ç­–ã®ä¿é™º */
timeBtn.addEventListener('click', () => logTimeEl.click());
timeHint.addEventListener('click', () => logTimeEl.click());

logTimeEl.addEventListener('change', () => {
  refreshTimeHint();
  expandInputBar();
});

/* æ·»ä»˜ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
let pendingDataUrl = null;
let pendingMime = '';
let pendingName = '';

function fileToDataURL(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = () => resolve(String(reader.result));
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

async function handleAttachment(file){
  if(!file) return;

  pendingMime = file.type || '';
  pendingName = file.name || '';
  pendingDataUrl = await fileToDataURL(file);

  previewArea.innerHTML = '';
  if (pendingMime.startsWith('image/')) {
    const img = document.createElement('img');
    img.src = pendingDataUrl;
    img.alt = 'attachment';
    previewArea.appendChild(img);
  } else {
    const div = document.createElement('div');
    div.className = 'filePreview';
    div.textContent = `ğŸ“ ${pendingName}`;
    previewArea.appendChild(div);
  }

  expandInputBar();
  logInput.focus();
}

fileInputEl.addEventListener('change', (e) => {
  const f = e.target.files && e.target.files[0];
  handleAttachment(f);
  e.target.value = '';
});

/* Enteré€ä¿¡ï¼ˆShift+Enterã§æ”¹è¡Œï¼‰ */
logInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    saveBtn.click();
    logInput.blur();
  }
});

/* ä¿å­˜ */
saveBtn.onclick = () => {
  const text = logInput.value.trim();
  const time = getTimeForSave();

  if(!text && !pendingDataUrl){
    collapseInputBar();
    logInput.blur();
    return;
  }

  const dayData = getDayData(currentDate);

  dayData.entries.push({
    time,
    text: text || (pendingMime.startsWith('image/') ? 'ğŸ“· å†™çœŸ' : `ğŸ“ ${pendingName || 'æ·»ä»˜'}`),
    photo: pendingMime.startsWith('image/') ? pendingDataUrl : null,
    fileName: pendingMime.startsWith('image/') ? null : pendingName
  });

  sortEntries(dayData);
  saveDayData(currentDate, dayData);
  loadDay(currentDate);

  // reset
  logInput.value = '';
  previewArea.innerHTML = '';
  pendingDataUrl = null;
  pendingMime = '';
  pendingName = '';

  // â˜…æ™‚é–“ã¯æœªæŒ‡å®šã«æˆ»ã™ï¼ˆè¡¨ç¤ºã¯ç¾åœ¨æ™‚åˆ»ã¸ï¼‰
  logTimeEl.value = '';
  refreshTimeHint();

  collapseInputBar();
  logInput.blur();
  showToast('ä¿å­˜ã—ã¾ã—ãŸ');
};

/* =======================
   Settings Modal
======================= */
const settingsBtn = $('settingsBtn');
const settingsModal = $('settingsModal');
const closeSettings = $('closeSettings');
const settingsBackdrop = $('settingsBackdrop');

function openSettings(){
  settingsModal.classList.add('open');
  settingsModal.setAttribute('aria-hidden','false');
}
function closeSettingsModal(){
  settingsModal.classList.remove('open');
  settingsModal.setAttribute('aria-hidden','true');
}
settingsBtn.onclick = openSettings;
closeSettings.onclick = closeSettingsModal;
settingsBackdrop.onclick = closeSettingsModal;
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeSettingsModal();
});

/* =======================
   Backup: export/import
======================= */
$('exportLogday').onclick = () => {
  const out = {};
  for (const k of Object.keys(localStorage)) {
    if (/^\d{4}-\d{2}-\d{2}$/.test(k)) out[k] = JSON.parse(localStorage.getItem(k));
  }
  const blob = new Blob([JSON.stringify(out)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `logday-backup-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
};

(() => {
  const input = $('importFile');
  const handler = async () => {
    const file = input.files && input.files[0];
    if (!file) return;

    try {
      const text = await file.text();
      const data = JSON.parse(text);

      const dateKeyRe = /^\d{4}-\d{2}-\d{2}$/;
      const dateKeys = Object.keys(data || {}).filter(k => dateKeyRe.test(k));
      if (dateKeys.length === 0) { showToast("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å½¢å¼ãŒé•ã†ã‹ã‚‚"); return; }

      if (!confirm(`ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã™ã‚‹ã‚ˆï¼ˆ${dateKeys.length}æ—¥åˆ†ï¼‰\nåŒã˜æ—¥ä»˜ã¯ä¸Šæ›¸ãã€‚\nå®Ÿè¡Œã™ã‚‹ï¼Ÿ`)) return;

      for (const k of dateKeys) localStorage.setItem(k, JSON.stringify(data[k]));
      alert(`å¾©å…ƒå®Œäº†ï¼ï¼ˆ${dateKeys.length}æ—¥åˆ†ï¼‰`);
      input.value = "";
      location.reload();
    } catch (err) {
      console.error(err);
      alert("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ãŸâ€¦");
    }
  };
  input.addEventListener("change", handler);
  input.addEventListener("input", handler);
})();

/* =======================
   Init
======================= */
generateCalendar();
showWeek();
refreshTimeHint();
startTimeTicker();
</script>

</body>
</html>
