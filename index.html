<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width,
               initial-scale=1,
               maximum-scale=1,
               minimum-scale=1,
               user-scalable=no,
               viewport-fit=cover">
<title>LOGDAY</title>

<style>
  body{
    font-family:-apple-system,BlinkMacSystemFont,sans-serif;
    padding:20px;
    line-height:1.6;
    background:#fafafa;
    padding-bottom: 170px; /* InputBar ã®ã¶ã‚“ */
  }

  /* =======================
     Top (sticky)
  ======================= */
  #topSticky{
    position: sticky;
    top: 0;
    z-index: 16000;

    margin: -20px -20px 12px;
    padding-top: env(safe-area-inset-top, 0px);

    background:#fff;
    border-bottom:1px solid #ddd;

    box-shadow: 0 2px 10px rgba(0,0,0,0.06);
  }
  #topSticky.isScrolled{
    box-shadow: 0 10px 26px rgba(0,0,0,0.18);
  }

  #topInner{ padding: 10px 12px 12px; }

  #nav{
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom:10px;
  }

  #navDate{
    font-size:18px;
    font-weight:600;
    color:#111;
    letter-spacing:.2px;
    user-select:none;
  }

  #navRight{
    margin-left:auto;
    display:flex;
    align-items:center;
    gap:8px;
  }

  .iconOnly{
    width:36px; height:32px; padding:0;
    display:inline-flex; align-items:center; justify-content:center;
    border-radius:10px;
    border:1px solid rgba(0,0,0,0.18);
    background:rgba(255,255,255,0.85);
    cursor:pointer;
    -webkit-tap-highlight-color: transparent;
    line-height:1;
  }
  .iconOnly:active{ transform: translateY(1px); }
  #toggleBtn{ font-size:14px; letter-spacing:.2px; }
  #settingsBtn{ font-size:18px; }

  #meta{margin-bottom:12px;color:#666;}
  #weather{font-weight:bold;}
  #dayNote{font-size:.9em;margin-top:4px;}

  /* =======================
     Calendar (month)
  ======================= */
  #calendar{
    display:grid;
    grid-template-columns:repeat(7,1fr);
    gap:4px;
    margin-bottom:12px;
  }
  #calendar button{
    padding:6px 0;
    border-radius:8px;
    border:1px solid rgba(0,0,0,0.16);
    background:#fff;
    cursor:pointer;
    font-size:.85em;
    -webkit-tap-highlight-color: transparent;
  }
  #calendar button.active{ background:#111; color:#fff; border-color:#111; }
  #calendar.hidden{display:none;}

  /* =======================
     Week bar (week)
  ======================= */
  #weekBar{
    display:grid;
    grid-template-columns:repeat(7,1fr);
    gap:6px;
    margin:10px 0 0;
  }
  #weekBar button{
    padding:8px 0;
    border-radius:12px;
    border:1px solid rgba(0,0,0,0.14);
    background:#fff;
    cursor:pointer;
    font-size:.85em;
    line-height:1.1;
    -webkit-tap-highlight-color: transparent;
  }
  #weekBar button .d{
    display:block;
    font-size:.75em;
    color:#666;
    margin-top:2px;
  }
  #weekBar button.active{background:#111;color:#fff;border-color:#111;}
  #weekBar button.active .d{color:#fff;opacity:.85;}

  /* =======================
     Entries
  ======================= */
  .entry{
    background:#fff;
    padding:10px 12px;
    border-radius:10px;
    box-shadow:0 1px 4px rgba(0,0,0,0.06);
    margin-bottom:12px;
    cursor:pointer;
    -webkit-tap-highlight-color: transparent;
  }
  .entry:active{ transform: translateY(1px); }

  .time{color:#888;width:60px;display:inline-block;vertical-align:top;}
  .text{
  display:block;
  margin-left:60px;
  white-space: pre-wrap;  /* â†ã“ã‚Œ */
  word-break: break-word; /* â†ãŠã¾ã‘ï¼ˆé•·æ–‡å´©ã‚Œé˜²æ­¢ï¼‰ */
}

  img.entryPhoto{
    display:block;
    margin-top:6px;
    margin-left:60px;
    max-width:100%;
    border-radius:10px;
  }
  .fileLine{
    margin-left:60px;
    margin-top:6px;
    color:#666;
    font-size:14px;
  }

  #entries{ min-height: 42vh; }
  .emptyState{
    min-height: 40vh;
    display:flex;
    align-items:center;
    justify-content:center;
    color:#888;
    text-align:center;
    font-size:.95em;
  }

/* =======================
   Input Bar (bottom) ç½®æ›ç”¨ï¼ˆå´©ã‚Œãªã„ç‰ˆï¼‰
======================= */

#inputBar{
  position:fixed;
  left:0; right:0; bottom:0;
  background:#fff;
  border-top:1px solid #ddd;
  padding:10px 12px;

  display:flex;
  flex-wrap:nowrap;          /* â˜…é€šå¸¸ã¯1æ®µå›ºå®š */
  align-items:center;
  gap:8px;

  z-index:9999;
  box-shadow: 0 -2px 10px rgba(0,0,0,0.06);
  max-height:320px;
}

/* â–¼ é€šå¸¸æ™‚ï¼šæ¨ªä¸¦ã³ï¼ˆï¼‹ / æ™‚åˆ» / å…¥åŠ› / ä¿å­˜ï¼‰ */
#plusBtn{ flex:0 0 auto; }
#timeHintWrap{ flex:0 0 auto; }

#logInput{
  flex:1 1 auto;             /* â˜…æ¨ªã«ä¼¸ã³ã‚‹ */
  min-width:0;               /* â˜…æ®µè½ã¡é˜²æ­¢ï¼ˆè¶…é‡è¦ï¼‰ */
  height:36px;
  resize:none;

  border-radius:12px;
  border:1px solid rgba(0,0,0,0.18);
  padding:8px 10px;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  box-sizing:border-box;
  outline:none;
  background:#fff;
  font-size:16px;
  line-height:1.4;

  /* â˜…â€œ1è¡Œã£ã½ãâ€è¦‹ã›ã‚‹ */
  overflow:hidden;
}

#saveBtn{
  flex:0 0 auto;
  height:34px;
  padding:0 14px;
  border-radius:12px;
  border:none;
  background:#111;
  color:#fff;
  cursor:pointer;
  white-space:nowrap;

  display:inline-flex;       /* â˜…å¸¸ã«è¡¨ç¤º */
  align-items:center;
  justify-content:center;
}

/* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ï¼šé€šå¸¸ã¯éè¡¨ç¤ºï¼ˆ1æ®µå›ºå®šã‚’å®ˆã‚‹ï¼‰ */
#previewArea{
  display:none;
  flex:0 0 100%;
  width:100%;
}
#inputBar.expanded #previewArea.hasContent{
  display:block;
  order:5;
}

/* â–¼ å±•é–‹æ™‚ï¼šå†™çœŸ1ã®å½¢ï¼ˆä¸Šã«å¤§ãã„å…¥åŠ›æ¬„ / ä¸‹ã«ãƒœã‚¿ãƒ³åˆ—ï¼‰ */
#inputBar.expanded{
  flex-wrap:wrap;            /* â˜…å±•é–‹æ™‚ã ã‘2æ®µOK */
  margin: 0 12px 12px;
  border-radius:16px;
  border-top:none;
  border:1px solid rgba(0,0,0,0.10);
  padding:12px;
  box-shadow: 0 -10px 26px rgba(0,0,0,0.18);
  transform: translateY(-2px);
  background: rgba(255,255,255,0.98);
  backdrop-filter: blur(10px);
}

/* å±•é–‹æ™‚ï¼šå…¥åŠ›æ¬„ãŒä¸Šæ®µ100%ï¼ˆå¤§ãã„è¦‹ãŸç›®ï¼‰ */
#inputBar.expanded #logInput{
  flex:0 0 100%;
  width:100%;
  order:1;

  height:120px;              /* â†å†™çœŸ1å¯„ã›ã€‚64ã«ã—ãŸã„ãªã‚‰64ã§ã‚‚OK */
  max-height:180px;
  border-radius:18px;
  border:1px solid rgba(0,0,0,0.16);
  padding:10px 12px;
  line-height:1.5;

  overflow:auto;             /* å±•é–‹æ™‚ã¯æ™®é€šã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
}

/* å±•é–‹æ™‚ï¼šä¸‹æ®µã«ãƒœã‚¿ãƒ³åˆ— */
#inputBar.expanded #plusBtn{ order:2; }
#inputBar.expanded #timeHintWrap{ order:3; }
#inputBar.expanded #saveBtn{
  order:4;
  margin-left:auto;          /* â˜…å³ç«¯ã¸ */
  height:40px;
  padding:0 16px;
  border-radius:14px;
}

/* --- æ—¢å­˜ã®éƒ¨å“ï¼ˆãã®ã¾ã¾ï¼‰ --- */
.iconBtn{
  width:34px; height:34px;
  border-radius:12px;
  border:1px solid rgba(0,0,0,0.14);
  background:#fff;
  cursor:pointer;
  font-size:16px;
  line-height:1;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  -webkit-tap-highlight-color: transparent;
  flex:0 0 auto;
}
.iconBtn:active{ transform: translateY(1px); }

#timeHintWrap{
  position:relative;
  height:34px;
  display:inline-flex;
  align-items:center;
  padding:0 10px;
  border-radius:12px;
  border:1px solid rgba(0,0,0,0.10);
  background:rgba(0,0,0,0.02);
  font-size:14px;
  color:#111;
  flex:0 0 auto;
  user-select:none;
  min-width:62px;
  justify-content:center;
}

.timeOverlay{
  position:absolute;
  inset:0;
  opacity:0;
  z-index:10001;
  border:none;
  background:transparent;
}

#previewArea img{
  max-width:100%;
  border-radius:10px;
  margin-top:8px;
}
#previewArea .filePreview{
  margin-top:8px;
  color:#666;
  font-size:14px;
}

/* â˜…ã“ã‚ŒãŒæŠœã‘ã‚‹ã¨ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã€ãŒå‡ºã¦å´©ã‚Œã‚‹ */
.fileInput{
  position:fixed;
  top:-10000px; left:-10000px;
  width:1px; height:1px;
  opacity:0;
  pointer-events:none;
}


  /* ===== Swipe to delete ===== */

  /* å‰Šé™¤ã‚¢ãƒ‹ãƒ¡ */
.entrySwipe.removing{
  animation: entryFadeOut .18s ease forwards;
}
@keyframes entryFadeOut{
  to { opacity:0; transform: scale(0.98); }
}

/* Content ã‚’ã‚¹ãƒ¯ã‚¤ãƒ—ã«è¿½å¾“ã•ã›ã‚‹æ™‚ã®è¦‹ãŸç›® */
.entryContent{
  transition: transform .32s cubic-bezier(.22,1.35,.3,1);
}

/* å‰Šé™¤ãƒœã‚¿ãƒ³ã®ä¸­èº«ï¼ˆã‚¢ã‚¤ã‚³ãƒ³+æ–‡å­—ï¼‰ */
.entryDeleteBtn{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:4px;
  font-size:12px;
}
.entryDeleteBtn .icon{
  font-size:18px;
  line-height:1;
}


.entrySwipe{
  position: relative;
  overflow: hidden;
  border-radius: 10px;
  margin-bottom: 12px;
  box-shadow:0 1px 4px rgba(0,0,0,0.06);
  background:#fff;
  touch-action: pan-y; /* ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å„ªå…ˆ */
}

.entryActions{
  position:absolute;
  top:0; right:0; bottom:0;
  display:flex;
  align-items:stretch;
  justify-content:flex-end;
  padding:0;
}

.entryDeleteBtn{
  width: 84px;
  border:none;
  background:#ff3b30;
  color:#fff;
  font-weight:600;
  cursor:pointer;
}

.entryContent{
  position: relative;
  background:#fff;
  padding:10px 12px;
  transform: translateX(0);
  will-change: transform;
  transition: transform .18s ease;
}

.entrySwipe.open .entryContent{
  transform: translateX(-84px); /* deleteå¹…ã¨åŒã˜ */
}

  /* =======================
     Plus Sheet
  ======================= */
  #plusSheet{
    position:fixed;
    inset:0;
    display:none;
    z-index:25000;
  }
  #plusSheet.open{ display:block; }
  #plusSheetBackdrop{
    position:absolute;
    inset:0;
    background:rgba(0,0,0,0.35);
  }
  #plusSheetPanel{
    position:absolute;
    left:12px;
    right:12px;
    bottom:12px;
    background:#fff;
    border-radius:16px;
    padding:10px;
    box-shadow:0 10px 30px rgba(0,0,0,0.22);
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .sheetBtn{
    height:44px;
    border-radius:12px;
    border:1px solid rgba(0,0,0,0.12);
    background:#fff;
    font-size:16px;
    cursor:pointer;
  }
  .sheetBtn.cancel{ background:rgba(0,0,0,0.04); }

  /* =======================
     Settings Modal
  ======================= */
  #settingsModal{
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 20000;
  }
  #settingsModal.open{ display:flex; }
  #settingsBackdrop{
    position:absolute;
    inset:0;
    background: rgba(0,0,0,0.35);
  }
  #settingsPanel{
    position: relative;
    width: min(520px, calc(100% - 32px));
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.22);
    padding: 16px;
  }
  #settingsPanel h3{ margin: 0 0 12px; font-size: 16px; }
  #settingsPanel .row{ display:flex; gap:10px; flex-wrap: wrap; }
  .ghostBtn{
    padding:10px 12px;
    border-radius:12px;
    border:1px solid rgba(0,0,0,0.18);
    background:#fff;
    cursor:pointer;
    font-size:.95em;
    display:inline-flex;
    align-items:center;
    justify-content:center;
  }

  #toast{
    position:fixed;
    left:50%;
    bottom:140px;
    transform:translateX(-50%);
    background:#111;
    color:#fff;
    padding:10px 18px;
    border-radius:999px;
    font-size:14px;
    opacity:0;
    pointer-events:none;
    transition:opacity .25s ease, transform .25s ease;
    z-index:30000;
  }
  #toast.show{
    opacity:1;
    transform:translateX(-50%) translateY(-4px);
  }
</style>
</head>

<body>

<div id="topSticky">
  <div id="topInner">
    <div id="nav">
      <div id="navDate"></div>
      <div id="navRight">
        <button id="toggleBtn" class="iconOnly" type="button" title="è¡¨ç¤ºåˆ‡æ›¿">æœˆ</button>
        <button id="settingsBtn" class="iconOnly" type="button" aria-label="è¨­å®š" title="è¨­å®š">âš™ï¸</button>
      </div>
    </div>

    <div id="calendar" class="hidden"></div>
    <div id="weekBar"></div>
  </div>
</div>

<div id="meta">
  <span id="weather"></span>
  <div id="dayNote"></div>
</div>

<div id="entries"></div>

<div id="inputBar">
  <button class="iconBtn" id="plusBtn" type="button" title="è¿½åŠ ">ï¼‹</button>

  <div id="timeHintWrap" title="æ™‚é–“">
    <div id="timeHint" class="isAuto"></div>
    <input id="logTime" type="time" class="timeOverlay" step="600">
  </div>

  

  <textarea id="logInput" placeholder="ä»Šæ—¥ã®ã²ã¨ã“ã¨â€¦"></textarea>
  <button id="saveBtn" type="button">ä¿å­˜</button>

  <div id="previewArea"></div>

  <input id="fileInput" type="file" class="fileInput" accept="*/*">
  <input id="pickPhotoInput" type="file" class="fileInput" accept="image/*">
  <input id="takePhotoInput" type="file" class="fileInput" accept="image/*" capture="environment">
</div>

<div id="plusSheet" aria-hidden="true">
  <div id="plusSheetBackdrop"></div>
  <div id="plusSheetPanel" role="dialog" aria-modal="true" aria-label="è¿½åŠ ">
    <button class="sheetBtn" id="actPhoto">å†™çœŸãƒ©ã‚¤ãƒ–ãƒ©ãƒª</button>
    <button class="sheetBtn" id="actCamera">å†™çœŸã‚’æ’®ã‚‹</button>
    <button class="sheetBtn" id="actFile">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
    <button class="sheetBtn cancel" id="actCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<div id="settingsModal" aria-hidden="true">
  <div id="settingsBackdrop"></div>
  <div id="settingsPanel" role="dialog" aria-modal="true" aria-label="è¨­å®š">
    <h3>è¨­å®š</h3>
    <div class="row">
      <button id="exportLogday" class="ghostBtn" type="button">ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãå‡ºã™</button>

      <label class="ghostBtn" role="button">
        ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã™ã‚‹
        <input id="importFile" class="fileInput" type="file" accept="application/json" />
      </label>

      <button id="closeSettings" class="ghostBtn" type="button">é–‰ã˜ã‚‹</button>

      <button id="timeStepBtn" class="ghostBtn" type="button">åˆ†åˆ»ã¿ï¼š10åˆ†</button>
    </div>
  </div>
</div>

<div id="toast">ä¿å­˜ã—ã¾ã—ãŸ</div>

<script>

/* =======================
   Utilities / Storage
======================= */
function byId(id){ return document.getElementById(id); }

function pad2(n){ return String(n).padStart(2,'0'); }
function nowHHMM(){
  const d = new Date();
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}
function uid(){
  return "e_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,8);
}
function formatYMD(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

function parseYMD(str){
  const [y,m,d] = str.split('-').map(Number);
  return new Date(y, m-1, d); // ãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜ã¨ã—ã¦æ‰±ã†
}

function timeToMinutes(t){
  if(!t) return 999999; // ç„¡æ™‚é–“ã¯æœ€å¾Œã«å›ã™
  const m = String(t).match(/^(\d{1,2}):(\d{2})$/);
  if(!m) return 999999;
  const h = parseInt(m[1],10);
  const mi = parseInt(m[2],10);
  return h*60 + mi;
}

function showToast(message){
  const toast = byId('toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 1200);
}

// ä¿å­˜ã¯ã“ã‚Œ1ã¤ã«çµ±ä¸€ï¼ˆå¤±æ•—æ™‚ã¯falseï¼‰
window.saveDayData = function(dateKey, dayData){
  try {
    localStorage.setItem(dateKey, JSON.stringify(dayData));
    return true;
  } catch (err) {
    console.error("saveDayData failed:", err);
    showToast("ä¿å­˜ã§ããªã‹ã£ãŸï¼ˆå®¹é‡ã‹ã‚‚ï¼‰");
    return false;
  }
};

function getDayData(dateKey){
  const dayData = JSON.parse(localStorage.getItem(dateKey) || '{}');
  dayData.entries = dayData.entries || [];

  // å¤ã„ãƒ‡ãƒ¼ã‚¿è£œå®Œï¼ˆã“ã“ã§ã¯ä¿å­˜ã—ãªã„ï¼‰
  dayData.entries.forEach(e=>{
    if(!e.id) e.id = uid();
    if(e.createdAt == null) e.createdAt = Date.now();
  });

  return dayData;
}

function sortEntries(dayData){
  const arr = dayData.entries || [];
  arr.sort((a,b)=>{
    const ta = timeToMinutes(a.time);
    const tb = timeToMinutes(b.time);
    if (ta !== tb) return ta - tb;

    const ca = a.createdAt ?? 0;
    const cb = b.createdAt ?? 0;
    if (ca !== cb) return ca - cb;

    return String(a.id||"").localeCompare(String(b.id||""));
  });
}

function parseYMD(str){
  const [y,m,d] = str.split('-').map(Number);
  return new Date(y, m-1, d); // â†ãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜ã¨ã—ã¦ç”Ÿæˆ
}



function roundTimeToStep(timeStr, stepMin){
  const m = String(timeStr || '').match(/^(\d{1,2}):(\d{2})$/);
  if (!m) return '';

  let h = parseInt(m[1], 10);
  let mi = parseInt(m[2], 10);

  // åˆ†â†’stepã§ä¸¸ã‚ï¼ˆå››æ¨äº”å…¥ï¼‰
  const rounded = Math.round(mi / stepMin) * stepMin;

  if (rounded === 60) {
    mi = 0;
    h = (h + 1) % 24;
  } else {
    mi = rounded;
  }

  return `${pad2(h)}:${pad2(mi)}`;
}



/* =======================
   App State
======================= */
let viewMode = 'week';
let currentDate = formatYMD(new Date());
let todayKey = formatYMD(new Date());

// input/edit
let timeMode = 'auto';
let selectedTime = '';
let tempTime = ''; // ãƒ”ãƒƒã‚«ãƒ¼æ“ä½œä¸­ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨
let timeTicker = null;
let editingId = null;
let isSaving = false;

const STEP_KEY = 'logday_time_step_min';

function getTimeStepMin(){
  const v = parseInt(localStorage.getItem(STEP_KEY) || '10', 10);
  return (v === 1 || v === 10) ? v : 10;
}

function setTimeStepMin(v){
  const step = (v === 1 || v === 10) ? v : 10;
  localStorage.setItem(STEP_KEY, String(step));
  applyTimeStepToUI(step);
  showToast(step === 1 ? 'åˆ†åˆ»ã¿ï¼š1åˆ†' : 'åˆ†åˆ»ã¿ï¼š10åˆ†');
}

let timeStepMin = getTimeStepMin();

// attachments pending
let pendingDataUrl = null;
let pendingMime = '';
let pendingName = '';

/* =======================
   Header / Date / Calendar
======================= */
function renderNavDate(dateStr){
  const d = parseYMD(dateStr);
  const dateText = d.toLocaleDateString('ja-JP',{
    year:'numeric',
    month:'2-digit',
    day:'2-digit'
  });
  const weekdayText = d.toLocaleDateString('ja-JP',{weekday:'short'});
  byId('navDate').textContent = `${dateText}ï¼ˆ${weekdayText}ï¼‰`;
}

function startOfWeek(dateStr){
  const d = parseYMD(dateStr);
  const day = d.getDay();
  const diff = (day === 0) ? -6 : (1 - day);
  d.setDate(d.getDate() + diff);
  return d;
}

function renderWeekBar(dateStr){
  const bar = byId('weekBar');
  bar.style.display = (viewMode === 'week') ? 'grid' : 'none';
  if (viewMode !== 'week') return;

  bar.innerHTML = '';
  const start = startOfWeek(dateStr);
  const wnames = ['æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ','æ—¥'];

  for(let i=0;i<7;i++){
    const d = new Date(start);
    d.setDate(start.getDate() + i);
    const ymd = formatYMD(d);

    const btn = document.createElement('button');
    btn.dataset.date = ymd;
    btn.innerHTML = `${wnames[i]}<span class="d">${d.getDate()}</span>`;
    btn.classList.toggle('active', ymd === currentDate);

    btn.onclick = () => {
      currentDate = ymd;
      loadDay(currentDate);
      renderWeekBar(currentDate);
      generateCalendar();
    };
    bar.appendChild(btn);
  }
}

function generateCalendar(){
  const cal = byId('calendar');
  cal.innerHTML = '';

  const d = new Date(currentDate);
  const year = d.getFullYear();
  const month = d.getMonth();

  const firstDay = new Date(year, month, 1);
  const lastDate = new Date(year, month + 1, 0).getDate();
  const blanks = (firstDay.getDay() + 6) % 7;

  for(let i=0;i<blanks;i++){
    const empty = document.createElement('button');
    empty.disabled = true;
    empty.style.visibility = 'hidden';
    cal.appendChild(empty);
  }

  for(let day=1; day<=lastDate; day++){
    const dayStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const btn = document.createElement('button');
    btn.textContent = day;
    btn.dataset.date = dayStr;
    btn.classList.toggle('active', dayStr === currentDate);

    btn.onclick = () => {
      currentDate = dayStr;
      loadDay(currentDate);
      generateCalendar();
      renderWeekBar(currentDate);
    };
    cal.appendChild(btn);
  }
}

const SWIPE_OPEN_X = -84;
const SWIPE_THRESHOLD = -42;
const SWIPE_FULL_DELETE = -170;
const SWIPE_OVERSHOOT = 26;
let openSwipeId = null;        // ä»Šé–‹ã„ã¦ã‚‹entryã®id
let swipeLock = { active:false, moved:false, id:null, startX:0, startY:0, currentX:0 };

function closeAllSwipes(){
  document.querySelectorAll('.entrySwipe.open').forEach(el => el.classList.remove('open'));
  openSwipeId = null;
}

function closeOtherSwipes(keepId){
  document.querySelectorAll('.entrySwipe.open').forEach(el => {
    if (el.dataset.id !== keepId) el.classList.remove('open');
  });
  openSwipeId = keepId;
}

function attachSwipeHandlers(wrapEl, contentEl){
  wrapEl.addEventListener('pointerdown', (e) => {
    if (e.pointerType === 'mouse' && e.button !== 0) return;

    swipeLock.active = true;
    swipeLock.moved = false;
    swipeLock.id = wrapEl.dataset.id;
    swipeLock.startX = e.clientX;
    swipeLock.startY = e.clientY;
    swipeLock.currentX = 0;

    closeOtherSwipes(wrapEl.dataset.id);

    contentEl.style.transition = 'none';
    wrapEl.setPointerCapture?.(e.pointerId);
  }, { passive: true });

  wrapEl.addEventListener('pointermove', (e) => {
    if (!swipeLock.active || swipeLock.id !== wrapEl.dataset.id) return;

    const dx = e.clientX - swipeLock.startX;
    const dy = e.clientY - swipeLock.startY;

    if (!swipeLock.moved && Math.abs(dy) > Math.abs(dx) && Math.abs(dy) > 6) {
      swipeLock.active = false;
      contentEl.style.transition = '';
      return;
    }

    if (Math.abs(dx) < 6 && Math.abs(dy) < 6) return;

    swipeLock.moved = true;

    const base = wrapEl.classList.contains('open') ? SWIPE_OPEN_X : 0;
    let x = base + dx;

    x = Math.min(0, x);

    if (x < SWIPE_FULL_DELETE) {
      const over = x - SWIPE_FULL_DELETE;
      x = SWIPE_FULL_DELETE + over * 0.35;
      x = Math.max(SWIPE_FULL_DELETE - SWIPE_OVERSHOOT, x);
    }

    swipeLock.currentX = x;
    contentEl.style.transform = `translateX(${x}px)`;
  }, { passive: true });

  const finish = () => {
    if (!swipeLock.active || swipeLock.id !== wrapEl.dataset.id) return;

    contentEl.style.transition = '';
    const x = swipeLock.currentX;

    if (!swipeLock.moved) {
      if (wrapEl.classList.contains('open')) {
        wrapEl.classList.remove('open');
        openSwipeId = null;
      }
      swipeLock.active = false;
      contentEl.style.transform = '';
      return;
    }

    if (x <= SWIPE_FULL_DELETE) {
      const kick = SWIPE_FULL_DELETE - 22;
      contentEl.style.transform = `translateX(${kick}px)`;
      setTimeout(() => {
        contentEl.style.transform = `translateX(${SWIPE_FULL_DELETE}px)`;
        deleteEntryById(wrapEl.dataset.id, wrapEl);
      }, 60);

      swipeLock.active = false;
      return;
    }

    if (x <= SWIPE_THRESHOLD) {
      wrapEl.classList.add('open');
      openSwipeId = wrapEl.dataset.id;
      contentEl.style.transform = '';
    } else {
      wrapEl.classList.remove('open');
      openSwipeId = null;
      contentEl.style.transform = '';
    }

    swipeLock.active = false;
  };

  wrapEl.addEventListener('pointerup', finish, { passive: true });
  wrapEl.addEventListener('pointercancel', finish, { passive: true });
}

function deleteEntryById(entryId, wrapEl){
  const dayData = getDayData(currentDate);
  const idx = dayData.entries.findIndex(e => e.id === entryId);
  if (idx < 0) return;

  // UIå…ˆè¡Œï¼šæ¶ˆãˆã‚‹ã‚¢ãƒ‹ãƒ¡
  if (wrapEl) wrapEl.classList.add('removing');

  // ã»ã‚“ã®å°‘ã—å¾…ã£ã¦ã‹ã‚‰å®Ÿå‰Šé™¤ï¼ˆã‚¢ãƒ‹ãƒ¡ãŒè¦‹ãˆã‚‹ï¼‰
  setTimeout(() => {
    dayData.entries.splice(idx, 1);
    sortEntries(dayData);

    const ok = window.saveDayData(currentDate, dayData);
    if (!ok) {
      // ä¿å­˜å¤±æ•—ãªã‚‰è¦‹ãŸç›®ã‚’æˆ»ã™ï¼ˆæœ€å°ï¼‰
      if (wrapEl) wrapEl.classList.remove('removing');
      return;
    }

    showToast('å‰Šé™¤ã—ã¾ã—ãŸ');
    loadDay(currentDate);
  }, 120);
}

// ç”»é¢ã‚¿ãƒƒãƒ—ã§é–‹ã„ã¦ã‚‹ã‚¹ãƒ¯ã‚¤ãƒ—ã‚’é–‰ã˜ã‚‹ï¼ˆå…¥åŠ›ãƒãƒ¼ä»¥å¤–ï¼‰
document.addEventListener('pointerdown', (e) => {
  if (openSwipeId && !e.target.closest('.entrySwipe')) closeAllSwipes();
}, {passive:true});

/* =======================
   Render Day
======================= */
function loadDay(dateStr){
  renderNavDate(dateStr);

  const entriesDiv = byId('entries');
  entriesDiv.innerHTML = '';

  const saved = getDayData(dateStr);
  sortEntries(saved);

  if(saved.entries && saved.entries.length){
    saved.entries.forEach(entry=>{
  const wrap = document.createElement('div');
  wrap.className = 'entrySwipe';
  wrap.dataset.id = entry.id || '';

  const actions = document.createElement('div');
  actions.className = 'entryActions';

  const delBtn = document.createElement('button');
  delBtn.className = 'entryDeleteBtn';
  delBtn.type = 'button';
  delBtn.innerHTML = `<span class="icon">ğŸ—‘ï¸</span><span class="label">å‰Šé™¤</span>`;

  delBtn.onclick = (ev) => {
  ev.stopPropagation();
  deleteEntryById(entry.id, wrap);
};

  actions.appendChild(delBtn);

  const content = document.createElement('div');
  content.className = 'entryContent';

  const time = document.createElement('span');
  time.className = 'time';
  time.textContent = (entry.time && entry.time.trim()) ? entry.time : 'â€¢';

  const text = document.createElement('span');
  text.className = 'text';
  text.textContent = entry.text || '';

  content.appendChild(time);
  content.appendChild(text);

  if (entry.photo) {
    const img = document.createElement('img');
    img.className = 'entryPhoto';
    img.src = entry.photo;
    img.alt = 'photo';
    content.appendChild(img);
  }

  if (entry.fileName) {
    const fileLine = document.createElement('div');
    fileLine.className = 'fileLine';
    fileLine.textContent = `ğŸ“ ${entry.fileName}`;
    content.appendChild(fileLine);
  }

  // ã‚¹ãƒ¯ã‚¤ãƒ—è¨­å®š
  attachSwipeHandlers(wrap, content);

  // ã‚¿ãƒƒãƒ—ç·¨é›†ï¼ˆã‚¹ãƒ¯ã‚¤ãƒ—ä¸­ã®èª¤ã‚¿ãƒƒãƒ—ã‚’é¿ã‘ã‚‹ï¼‰
  content.addEventListener('click', (ev) => {
    // é–‹ã„ã¦ã‚‹æ™‚ã¯ã‚¿ãƒƒãƒ—=é–‰ã˜ã‚‹å„ªå…ˆï¼ˆç·¨é›†ã—ãªã„ï¼‰
    if (wrap.classList.contains('open')) {
      wrap.classList.remove('open');
      openSwipeId = null;
      return;
    }
    // ã‚¹ãƒ¯ã‚¤ãƒ—ç§»å‹•ç›´å¾Œã¯ç·¨é›†ã—ãªã„
    if (swipeLock.moved) return;

    beginEditById(entry.id);
  });

  wrap.appendChild(actions);
  wrap.appendChild(content);
  entriesDiv.appendChild(wrap);
});
  } else {
    entriesDiv.innerHTML = '<div class="emptyState">ã“ã®æ—¥ã¯ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
  }
}

/* =======================
   View Switch
======================= */
const toggleBtn = byId('toggleBtn');
const calEl = byId('calendar');
const weekBarEl = byId('weekBar');

function updateToggleLabel(){
  toggleBtn.textContent = (viewMode === 'week') ? 'æœˆ' : 'é€±';
  toggleBtn.title = (viewMode === 'week') ? 'æœˆè¡¨ç¤ºã¸' : 'é€±è¡¨ç¤ºã¸';
}
function showWeek(){
  viewMode = 'week';
  calEl.classList.add('hidden');
  weekBarEl.style.display = 'grid';
  renderWeekBar(currentDate);
  loadDay(currentDate);
  updateToggleLabel();
}
function showMonth(){
  viewMode = 'month';
  calEl.classList.remove('hidden');
  weekBarEl.style.display = 'none';
  generateCalendar();
  loadDay(currentDate);
  updateToggleLabel();
}
toggleBtn.onclick = () => (viewMode === 'week') ? showMonth() : showWeek();



/* =======================
   Input Bar ç½®æ›ï¼ˆbeforeinput / input / blurï¼‰
======================= */
const inputBar = byId('inputBar');
const plusBtn  = byId('plusBtn');
const logInput = byId('logInput');
const saveBtn  = byId('saveBtn');

const timeHint  = byId('timeHint');
const logTimeEl = byId('logTime');

const fileInputEl = byId('fileInput');
const photoEl     = byId('pickPhotoInput');
const cameraEl    = byId('takePhotoInput');
const previewArea = byId('previewArea');

const plusSheet = byId('plusSheet');
const plusSheetBackdrop = byId('plusSheetBackdrop');
const actPhoto = byId('actPhoto');
const actCamera= byId('actCamera');
const actFile  = byId('actFile');
const actCancel= byId('actCancel');

function expandInputBar(){ inputBar.classList.add('expanded'); }
function collapseInputBar(){ inputBar.classList.remove('expanded'); }

function setPreviewVisible(isOn){
  previewArea.classList.toggle('hasContent', !!isOn);
}

function refreshTimeHint(){
  if (timeMode === 'set' && selectedTime) {
    timeHint.textContent = selectedTime;
    timeHint.className = 'isSet';
    return;
  }
  timeHint.textContent = nowHHMM();
  timeHint.className = 'isAuto';
}


function applyTimeStepToUI(stepMin){
  timeStepMin = stepMin;

  // type="time" ã® step ã¯ â€œç§’â€
  // 1åˆ†=60ç§’ / 10åˆ†=600ç§’
  logTimeEl.step = String(stepMin * 60);
}


function startTimeTicker(){
  if (timeTicker) return;

  timeTicker = setInterval(() => {
    // â‘  æ™‚åˆ»ãƒ’ãƒ³ãƒˆæ›´æ–°ï¼ˆä»Šã¾ã§é€šã‚Šï¼‰
    if (timeMode === 'auto') refreshTimeHint();

    // â‘¡ 0:00è·¨ãæ¤œçŸ¥ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜ï¼‰
    const nowKey = formatYMD(new Date());
    if (nowKey !== todayKey) {
      const prevKey = todayKey;
      todayKey = nowKey;

      // ã€Œå‰æ—¥ï¼ˆ=ã„ã¾è¡¨ç¤ºã—ã¦ãŸæ—¥ï¼‰ã€ã‚’è¦‹ã¦ãŸæ™‚ã ã‘ç¿Œæ—¥ã«è‡ªå‹•ã‚¸ãƒ£ãƒ³ãƒ—
      // â€» éå»æ—¥ã‚’è¦‹ã¦ã‚‹æ™‚ã«å‹æ‰‹ã«é£›ã°ãªã„ãŸã‚ã®ã‚¬ãƒ¼ãƒ‰
      if (currentDate === prevKey) {
        currentDate = nowKey;

        loadDay(currentDate);
        renderWeekBar(currentDate);
        generateCalendar();

        showToast("æ—¥ä»˜ãŒå¤‰ã‚ã‚Šã¾ã—ãŸ");
      }
    }
  }, 1000);
}

/* æ™‚è¨ˆã‚¿ãƒƒãƒ— â†’ ãƒ”ãƒƒã‚«ãƒ¼ã‚’é–‹ãæº–å‚™ã ã‘ï¼ˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¥ªã‚ãªã„ï¼‰ */
logTimeEl.addEventListener('pointerdown', () => {
  // ç©ºã®ã¾ã¾ã ã¨é–‹ãã«ãã„ç«¯æœ«å¯¾ç­–ï¼šåˆå›ã ã‘ now ã‚’å…¥ã‚Œã‚‹
  if (!logTimeEl.value) logTimeEl.value = nowHHMM();
  // ã“ã“ã§ã¯ refreshTimeHint() ã—ãªã„ï¼ˆå‹æ‰‹ã«ç¢ºå®šã•ã›ãªã„ï¼‰
}, { passive:true });

/* å›ã—ã¦ã‚‹æœ€ä¸­ï¼šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã ã‘æ›´æ–°ï¼ˆç¢ºå®šã—ãªã„ï¼‰ */
logTimeEl.addEventListener('input', () => {
  tempTime = logTimeEl.value || '';
  if (tempTime) {
    timeHint.textContent = tempTime;
    timeHint.className = 'isSet'; // è¦‹ãŸç›®ã¯ã‚»ãƒƒãƒˆã£ã½ãã—ã¦OK
  } else {
    refreshTimeHint();
  }

  // â˜…ã“ã“ã§ logInput.focus() ã—ãªã„ï¼
  // â˜…ã“ã“ã§ timeMode ã‚’ç¢ºå®šã—ãªã„ï¼
}, { passive:true });

/* ãƒ”ãƒƒã‚«ãƒ¼ã‚’é–‰ã˜ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ç¢ºå®šï¼ˆiOSã¯blurãŒå®‰å®šï¼‰ */
logTimeEl.addEventListener('blur', () => {
  const raw = logTimeEl.value || '';
  const rounded = raw ? roundTimeToStep(raw, timeStepMin) : '';

  logTimeEl.value = rounded;      // ãƒ”ãƒƒã‚«ãƒ¼å€¤ã‚’ä¸¸ã‚å¾Œã«æ›´æ–°
  selectedTime = rounded;
  timeMode = selectedTime ? 'set' : 'auto';
  tempTime = '';

  refreshTimeHint();
  expandInputBar();
}, { passive:true });

/* å¿µã®ãŸã‚ï¼šchangeã§ã‚‚ç¢ºå®šï¼ˆç«¯æœ«å·®ï¼‰ */
logTimeEl.addEventListener('change', () => {
  const raw = logTimeEl.value || '';
  const rounded = raw ? roundTimeToStep(raw, timeStepMin) : '';

  logTimeEl.value = rounded;
  selectedTime = rounded;
  timeMode = selectedTime ? 'set' : 'auto';
  tempTime = '';

  refreshTimeHint();
  expandInputBar();
}, { passive:true });


/* --- ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã§å±•é–‹ï¼ˆå†™çœŸ1ï¼‰ --- */
logInput.addEventListener('focus', () => {
  expandInputBar();
});

/* âœ… beforeinput/inputï¼šçŠ¶æ…‹ã‚’â€œæ•´ãˆã‚‹â€ã ã‘ï¼ˆä¿å­˜ã¯ã—ãªã„ï¼‰ */
let isComposing = false;
logInput.addEventListener('compositionstart', () => { isComposing = true; });
logInput.addEventListener('compositionend',   () => { isComposing = false; });

logInput.addEventListener('beforeinput', (e) => {
  // æ–‡å­—ãŒå…¥ã‚Šå§‹ã‚ãŸã‚‰å±•é–‹ã‚’ç¶­æŒï¼ˆiOSã§åŠ¹ãã“ã¨å¤šã„ï¼‰
  if (!inputBar.classList.contains('expanded')) expandInputBar();
});

logInput.addEventListener('input', () => {
  // ã“ã“ã§ã¯ä¿å­˜ã—ãªã„ã€‚UIçŠ¶æ…‹ã ã‘ã€‚
  // ä¾‹ï¼šè¤‡æ•°è¡Œã«ãªã£ã¦ã‚‚OKï¼ˆã‚¨ãƒ³ãƒˆãƒªãƒ¼ã¯ãã®ã¾ã¾ä¿å­˜ãƒœã‚¿ãƒ³ã§ï¼‰
});

/* âœ… blurï¼šiOSã®ã€Œâ˜‘ï¸ï¼ˆå®Œäº†ï¼‰ã€â†’ blur ã«ãªã‚‹ã®ã§ â€œå†™çœŸ2ï¼ˆé€šå¸¸ï¼‰â€ ã«æˆ»ã™
   â€» ãƒ†ã‚­ã‚¹ãƒˆã¯æ¶ˆã•ãªã„ */
logInput.addEventListener('blur', () => {
  setTimeout(() => {
    collapseInputBar();
  }, 80);
});

/* å…¥åŠ›ãƒãƒ¼å¤–ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹ï¼ˆãƒ†ã‚­ã‚¹ãƒˆã¯æ®‹ã™ï¼‰ */
document.addEventListener('pointerdown', (e) => {
  if (document.activeElement !== logInput) return;
  if (inputBar.contains(e.target)) return;
  logInput.blur();            // blurå´ã§collapseã•ã‚Œã‚‹
  editingId = null;           // ç·¨é›†è§£é™¤ã ã‘
}, { passive:true });

/* Enterã¯æ”¹è¡Œï¼ˆä½•ã‚‚ã—ãªã„ï¼‰ */
logInput.addEventListener('keydown', (e) => {
  if (isComposing || e.isComposing || e.keyCode === 229) return;
  // preventDefaultã—ãªã„ï¼æ”¹è¡Œã«ãªã‚‹
});

/* =======================
   Plus Sheet
======================= */
function openPlusSheet(){
  plusSheet.classList.add('open');
  plusSheet.setAttribute('aria-hidden','false');
}
function closePlusSheet(){
  plusSheet.classList.remove('open');
  plusSheet.setAttribute('aria-hidden','true');
}
plusBtn.onclick = openPlusSheet;
plusSheetBackdrop.onclick = closePlusSheet;
actCancel.onclick = closePlusSheet;

actPhoto.onclick = () => { closePlusSheet(); photoEl.click(); };
actCamera.onclick= () => { closePlusSheet(); cameraEl.click(); };
actFile.onclick  = () => { closePlusSheet(); fileInputEl.click(); };

/* =======================
   Attachments
======================= */
function fileToDataURL(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = () => resolve(String(reader.result));
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

async function handleAttachment(file){
  if(!file) return;

  pendingMime = file.type || '';
  pendingName = file.name || '';
  pendingDataUrl = await fileToDataURL(file);

  previewArea.innerHTML = '';
  if (pendingMime.startsWith('image/')) {
    const img = document.createElement('img');
    img.src = pendingDataUrl;
    img.alt = 'attachment';
    previewArea.appendChild(img);
  } else {
    const div = document.createElement('div');
    div.className = 'filePreview';
    div.textContent = `ğŸ“ ${pendingName}`;
    previewArea.appendChild(div);
  }

  setPreviewVisible(true);
  expandInputBar();
  logInput.focus();
}

[fileInputEl, photoEl, cameraEl].forEach(inp => {
  inp.addEventListener('change', (e) => {
    const f = e.target.files && e.target.files[0];
    handleAttachment(f);
    e.target.value = '';
  });
});

/* ä¿å­˜å¾Œã®ãƒªã‚»ãƒƒãƒˆæ™‚ã«previewè¡¨ç¤ºã‚‚æˆ»ã™ãŸã‚ï¼ˆsaveBtnå´ã®æœ€å¾Œã«å…¥ã‚Œã‚‹ã®ãŒç†æƒ³ï¼‰
   ã™ã§ã«ã‚ãªãŸã®saveBtn.onclickå†…ã§ previewArea.innerHTML='' ã—ã¦ã‚‹ã®ã§ã€
   ãã®ç›´å¾Œã« setPreviewVisible(false); ã‚’è¶³ã—ã¦ã­ */


/* =======================
   Edit (B)
======================= */
function beginEditEntry(entry){
  editingId = entry.id;

  expandInputBar();
  logInput.value = entry.text || "";

  if (!entry.time) {
  timeMode = 'auto';
  selectedTime = '';
  logTimeEl.value = '';
  refreshTimeHint();
} else {
  timeMode = 'set';
  selectedTime = entry.time;
  logTimeEl.value = entry.time;
  refreshTimeHint();
}

  // æ·»ä»˜ä¿æŒï¼ˆå†™çœŸã¯DataURLãŒæ®‹ã‚‹ï¼‰
  pendingDataUrl = entry.photo || null;
  pendingName = entry.fileName || '';
  pendingMime = entry.photo ? 'image/*' : (entry.fileName ? 'application/*' : '');

  previewArea.innerHTML = '';
  if (pendingDataUrl && entry.photo) {
    const img = document.createElement('img');
    img.src = pendingDataUrl;
    img.alt = 'attachment';
    previewArea.appendChild(img);
  } else if (pendingName) {
    const div = document.createElement('div');
    div.className = 'filePreview';
    div.textContent = `ğŸ“ ${pendingName}`;
    previewArea.appendChild(div);
  }

  previewArea.classList.remove('hasContent');

  setTimeout(()=>logInput.focus(), 0);
  showToast('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰');
}

function beginEditById(entryId){
  const dayData = getDayData(currentDate);
  const entry = (dayData.entries || []).find(e => e.id === entryId);
  if (!entry) { showToast('ç·¨é›†å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚‰ãªã„â€¦'); return; }
  beginEditEntry(entry);
}



/* =======================
   Save
======================= */
saveBtn.onclick = () => {
  if (isSaving) return;
  isSaving = true;

  try {
    const text = logInput.value.trim();

    let time = '';
if (timeMode === 'set') {
  time = time = roundTimeToStep(selectedTime, timeStepMin) || selectedTime;
  selectedTime = time;
  logTimeEl.value = time;
} else if (timeMode === 'auto') {
  time = nowHHMM();
} else {
  time = '';
}

    if (!text && !pendingDataUrl) {
      collapseInputBar();
      logInput.blur();
      return;
    }

    const dayData = getDayData(currentDate);

    const isImage = !!pendingDataUrl && String(pendingMime).startsWith('image/');
    const hasFileName = !!pendingName && !isImage;

    const newPayload = {
      time,
      text: text || (isImage ? 'ğŸ“· å†™çœŸ' : (hasFileName ? `ğŸ“ ${pendingName}` : '')),
      photo: isImage ? pendingDataUrl : null,
      fileName: hasFileName ? pendingName : null
    };

    if (editingId) {
      const idx = dayData.entries.findIndex(e => e.id === editingId);
      if (idx >= 0) {
        dayData.entries[idx] = { ...dayData.entries[idx], ...newPayload };
        showToast('æ›´æ–°ã—ã¾ã—ãŸ');
      } else {
        dayData.entries.push({ id: uid(), createdAt: Date.now(), ...newPayload });
        showToast('è¿½åŠ ã—ã¾ã—ãŸ');
      }
    } else {
      dayData.entries.push({ id: uid(), createdAt: Date.now(), ...newPayload });
      showToast('ä¿å­˜ã—ã¾ã—ãŸ');
    }

    sortEntries(dayData);

    const ok = window.saveDayData(currentDate, dayData);
    if (!ok) return; // å¤±æ•—æ™‚ã¯å…¥åŠ›ã‚’æ®‹ã™

    loadDay(currentDate);

    // reset
    editingId = null;

    logInput.value = '';
    previewArea.innerHTML = '';
    setPreviewVisible(false);
    pendingDataUrl = null;
    pendingMime = '';
    pendingName = '';

    timeMode = 'auto';
    selectedTime = '';
    logTimeEl.value = '';
    refreshTimeHint();
    

    collapseInputBar();
    logInput.blur();

  } finally {
    setTimeout(() => { isSaving = false; }, 160);
  }
};

/* =======================
   Settings Modal
======================= */
const settingsBtn = byId('settingsBtn');
const settingsModal = byId('settingsModal');
const closeSettings = byId('closeSettings');
const settingsBackdrop = byId('settingsBackdrop');

function openSettings(){
  settingsModal.classList.add('open');
  settingsModal.setAttribute('aria-hidden','false');

  byId('closeSettings').focus(); // æœ€åˆã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
}


function closeSettingsModal(){

  // â˜… ã¾ãšãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å®‰å…¨ãªå ´æ‰€ã¸é€ƒãŒã™
  settingsBtn.focus();   // è¨­å®šãƒœã‚¿ãƒ³ã«æˆ»ã™ã®ãŒè‡ªç„¶

  settingsModal.classList.remove('open');
  settingsModal.setAttribute('aria-hidden','true');
}


settingsBtn.onclick = openSettings;
closeSettings.onclick = closeSettingsModal;
settingsBackdrop.onclick = closeSettingsModal;
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeSettingsModal();
});

/* export/import */
byId('exportLogday').onclick = () => {
  const out = {};
  for (const k of Object.keys(localStorage)) {
    if (/^\d{4}-\d{2}-\d{2}$/.test(k)) out[k] = JSON.parse(localStorage.getItem(k));
  }
  const blob = new Blob([JSON.stringify(out)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `logday-backup-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
};


const timeStepBtn = byId('timeStepBtn');

function refreshTimeStepLabel(){
  if (!timeStepBtn) return;
  timeStepBtn.textContent = (timeStepMin === 1) ? 'åˆ†åˆ»ã¿ï¼š1åˆ†' : 'åˆ†åˆ»ã¿ï¼š10åˆ†';
}

if (timeStepBtn){
  refreshTimeStepLabel();

  timeStepBtn.onclick = () => {
    // ãƒˆã‚°ãƒ«å¼ï¼š10â‡„1
    const next = (timeStepMin === 10) ? 1 : 10;
    setTimeStepMin(next);
    refreshTimeStepLabel();
  };
}


(() => {
  const input = byId('importFile');
  const handler = async () => {
    const file = input.files && input.files[0];
    if (!file) return;

    try {
      const text = await file.text();
      const data = JSON.parse(text);

      const dateKeyRe = /^\d{4}-\d{2}-\d{2}$/;
      const dateKeys = Object.keys(data || {}).filter(k => dateKeyRe.test(k));
      if (dateKeys.length === 0) { showToast("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å½¢å¼ãŒé•ã†ã‹ã‚‚"); return; }

      if (!confirm(`ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã™ã‚‹ã‚ˆï¼ˆ${dateKeys.length}æ—¥åˆ†ï¼‰\nåŒã˜æ—¥ä»˜ã¯ä¸Šæ›¸ãã€‚\nå®Ÿè¡Œã™ã‚‹ï¼Ÿ`)) return;

      for (const k of dateKeys) localStorage.setItem(k, JSON.stringify(data[k]));
      alert(`å¾©å…ƒå®Œäº†ï¼ï¼ˆ${dateKeys.length}æ—¥åˆ†ï¼‰`);
      input.value = "";
      location.reload();
    } catch (err) {
      console.error(err);
      alert("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ãŸâ€¦");
    }
  };
  input.addEventListener("change", handler);
  input.addEventListener("input", handler);
})();

/* top shadow */
(() => {
  const topSticky = byId('topSticky');
  const TH = 6;
  const onScroll = () => topSticky.classList.toggle('isScrolled', window.scrollY > TH);
  window.addEventListener('scroll', onScroll, { passive: true });
  onScroll();
})();

/* init */
generateCalendar();
showWeek();
refreshTimeHint();
startTimeTicker();
applyTimeStepToUI(timeStepMin);
</script>

</body>
</html>
